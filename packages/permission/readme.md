<h1 align="center" style="color: #61dafb;">Permission</h1>
<h1 align="center" style="font-size: 80px;color:#61dafb">ğŸ”‘</h1>



<br>

## å®‰è£…

```shell
npm install @m78/permission
```

<br>


## ä»‹ç»

æ­¤åº“åŒ…å«ä¸¤ç§æƒé™å®ç°:

1. å¸¸è§„ç‰ˆæœ¬ï¼ŒéªŒè¯é€šè¿‡æœ¬åœ°éªŒè¯å™¨å’Œä¸€ç»„çŠ¶æ€æ¥å®ç°, é€‚åˆåªåŒ…å«ä¸­å°‘é‡æƒé™éªŒè¯çš„å‰å°é¡¹ç›®ã€‚
2. `Pro` ç‰ˆæœ¬ï¼Œé€šè¿‡è¿›ä¸€æ­¥çš„å°è£…ç®€åŒ–äº†apiçš„æ•´ä½“ä½¿ç”¨ï¼Œé€‚åˆåŒ…å«å¤§é‡å¤æ‚æƒé™é€»è¾‘çš„ä¸­åå°é¡¹ç›®ï¼Œå¹¶ä¸”å¯ä»¥éå¸¸ç®€å•çš„å’Œä»»æ„åç«¯ä½“ç³»é›†æˆã€‚

<br>

* ä½¿ç”¨äº†[@m78/seed](https://github.com/xianjie-li/m78/tree/master/packages/seed)æ¥ç®¡ç†çŠ¶æ€, `seed`æ˜¯ä¸€ä¸ªéå¸¸ç®€å•æ˜“å­¦çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œä½¿ç”¨å‰å»ºè®®å…ˆäº†è§£ä¸‹å®ƒçš„ç”¨æ³•ã€‚
* å®ƒè¢«è®¾è®¡å¾—è¶³å¤Ÿé€šç”¨ï¼Œå¯ä»¥åœ¨ä»»æ„jsè¿è¡Œæ—¶ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº`nodejs` `ReactNative` `å°ç¨‹åº `ç­‰, å¦‚æœä½ çš„å‰åç«¯éƒ½æ˜¯jsçš„è¯, ç”šè‡³å¯ä»¥å¤ç”¨ä¸€å¥—æƒé™é€»è¾‘ã€‚
* å¦‚æœä½ åœ¨å‰ç«¯æ¡†æ¶ä¸­ä½¿ç”¨ï¼Œå¯èƒ½ä¼šéœ€è¦å¯¹å…¶è¿›è¡Œç®€å•çš„å°è£…, è‹¥ä½¿ç”¨reactï¼Œå¯ä»¥ä½¿ç”¨å®˜æ–¹å®ç° [m78/permission](https://github.com/xianjie-li/m78) , å…¶ä»–æ¡†æ¶å¯ä»¥å‚è€ƒå…¶å®ç°æ¥ç¼–å†™ã€‚

<br>


## Permission

è¿™æ˜¯åŒ…å«`Auth` æ‰€æœ‰ `api` çš„ä¼ªä»£ç ç¤ºä¾‹ï¼š

```ts
import create from '@m78/seed';
import { create as createPermission } from '@m78/permission';

const seed = create({
  /** åˆå§‹çŠ¶æ€ */
  state: {
    name: 'lxj',
    roleType: 1,
    age: 17,
  },
});

/** createPermission()ç”¨äºåˆ›å»ºä¸€ä¸ªPermissionå®ä¾‹ */
const permission = createPermission({
    seed,
    /**
      * å¦‚æœä¸€ä¸ªéªŒè¯æœªé€šè¿‡ï¼Œåˆ™é˜»æ­¢åç»­éªŒè¯
      * - å¯¹äºorä¸­çš„å­æƒé™ï¼Œå³ä½¿å¼€å¯äº†validFirstï¼Œä¾ç„¶ä¼šå¯¹æ¯ä¸€é¡¹è¿›è¡ŒéªŒè¯ï¼Œä½†æ˜¯åªä¼šè¿”å›ç¬¬ä¸€ä¸ª
      * - åœ¨æ‰§è¡ŒéªŒè¯æ—¶å°†ä¼˜å…ˆçº§æ›´é«˜çš„æƒé™keyæ”¾åˆ°å‰é¢æœ‰åŠ©äºæé«˜éªŒè¯åé¦ˆçš„ç²¾åº¦, å¦‚ login > publisher, å› ä¸ºpublisherçŠ¶æ€æ˜¯ä»¥loginä¸ºå‰æçš„
      **/
    validFirst: true,
    /** éªŒè¯å™¨, ä¸€ä¸ªæ¥æ”¶å½“å‰stateå’Œé¢å¤–å‚æ•°è¿”å›éªŒè¯metaæ–°çš„çš„å‡½æ•° */
    validators: {
        isAdmin(state) {
            if (state.roleType !== 1) {
                // éªŒè¯æœªé€šè¿‡æ—¶è¿”å›çš„è¯¦ç»†ä¿¡æ¯
                return {
                  	// å¿…é¡»å­—æ®µ
                    label: '403',
                  	// ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€äº›æ‰©å±•å­—æ®µ, ç”¨æ¥å¸®åŠ©æ›´å¥½çš„å±•ç¤ºéªŒè¯ç»“æœå’Œå¯ç”¨çš„æ“ä½œ, æ¯”å¦‚:
                    desc: 'ä½ ä¸æ˜¯ç®¡ç†å‘˜',
                    actions: [
                        {
                            label: 'åˆ‡æ¢è´¦å·',
                            handle() {...},
                        },
                        {
                            label: 'æ”¾å¼ƒæ“ä½œ',
                        },
                    ],
                };
            }
        },
        is18plus(state, extra) {
            if (state.age < 18) {
                return {
                    label: '403',
                    desc: 'æœªæ»¡18å²',
                    actions: [
                        {
                            label: 'åˆ‡æ¢è´¦å·',
                        },
                    ],
                };
            }
        },
    }
});

// æƒé™éªŒè¯, éªŒè¯è¢«æ‹’ç»æ—¶ï¼Œä¼šå°†æ‰€æœ‰æœªéªŒè¯é€šè¿‡çš„éªŒè¯å™¨è¿”å›ä½œä¸ºè¯¦ç»†ä¿¡æ¯è¿”å›, æˆåŠŸåˆ™è¿”å›null
permission(['isAdmin', 'is18plus']);

// éªŒè¯å¤±è´¥çš„è¿”å›æ˜¯è¿™æ ·å­çš„
[
  {
    /** è¯¥æƒé™åç§° */
    label: string;
    // å…¶ä»–æ‰©å±•å­—æ®µ
  }
]

// å½“æƒé™é¡¹æ˜¯ä¸€ä¸ªæ•°ç»„æ—¶ï¼Œè¡¨ç¤ºæ¡ä»¶`or`ï¼Œ è¡¨ç¤ºå…¶ä¸­ä»»æ„ä¸€ä¸ªæƒé™é€šè¿‡å³å¯
permission(['isAdmin', ['is18plus', 'someVa..']]);

// ä¼ å…¥é…ç½®
permission(['isAdmin'], {
  /** ä¼ é€’ç»™éªŒè¯å™¨çš„é¢å¤–å‚æ•°, æ¯”å¦‚ç”¨æˆ·id */
  extra?: any;
  /** å±€éƒ¨éªŒè¯å™¨ */
  validators?: Validators<S>;
});
```



## PermissionPro

è¿™æ˜¯åŒ…å«`PermissionPro`æ‰€æœ‰ `api` çš„ä¼ªä»£ç ç¤ºä¾‹ï¼š

```ts
import create from '@m78/seed';
import { createPro } from '@m78/auth';

/**
 * æƒé™æ¨¡æ¿
 *
 * æƒé™æ¨¡æ¿æ ¼å¼å¦‚: `module:keys`
 * - nameä¸ºæƒé™æ‰€å±æ¨¡å—
 * - keysä¸ºå…·ä½“çš„æƒé™
 *
 * æ¨¡æ¿ä¸­å¯ä»¥ä½¿ç”¨ä¸€äº›DSLè¯­æ³•, æ¯”å¦‚:
 * - user:create&update
 * - user:create|update
 * - user:create&update|delete
 * - user:create&(update|update2)
 * */
const keys = ['user:create'];

const ownPermission = {
  user: ['create', 'update', 'delete'],
  news: ['create', 'update', 'delete'],
};

/** åˆ›å»ºä¸€ä¸ªauthPro */
const pro = createPro({
  /** åˆå§‹æƒé™ */
  permission: ownPermission;
 	/** metaæ˜¯ä¸€ä¸ªå¯é€‰é…ç½®, ç”¨æ¥ä¸ºæƒé™é™„åŠ æ›´å¤šçš„å¯ç”¨ä¿¡æ¯, å¦‚æƒé™å, æƒé™æè¿°, å¯ç”¨çš„æ“ä½œç­‰ç­‰, æ–¹ä¾¿ä½¿ç”¨è€…é€šè¿‡è¿™äº›ä¿¡æ¯åˆ›å»ºæ›´å‹å¥½çš„å¤±è´¥åé¦ˆ. */
  meta: {
     // åŒ¹é…æ‰€æœ‰åŒåkeyçš„meta
     general: [
        {
   				// å¿…é¡»çš„å­—æ®µ
          label: 'åˆ›å»º',
          key: 'create',
  				// ä½ ä¹Ÿå¯ä»¥æ‰©å±•ä¸€äº›å…¶ä»–å­—æ®µ
  				desc: 'åˆ›å»ºæŸäº›ä¸œè¥¿..'
      	},
     ],
     // é’ˆå¯¹ç‰¹å®šæ¨¡å—çš„meta, ä¼˜å…ˆçº§å¤§äºgeneral
     modules: {
        // æŒ‡å®šæ¨¡å—åç§°å’Œå…¶å¯¹åº”çš„æƒé™é¡¹
        user: {
          label: 'ç”¨æˆ·',
        	list: [
            {
              label: 'æ›´æ–°',
              key: 'update',
            },
        	]
        },
        // å¦‚æœä¸éœ€è¦æŒ‡å®šæ¨¡å—ååˆ™å¯ä»¥ç›´æ¥ä¼ æƒé™é¡¹é…ç½®
        news: [...]
     },
     // å¯ç”¨äºåœ¨éªŒè¯metaç”Ÿæˆå‰å¯¹å…¶æ”¹å†™
     each: meta => meta,
  },
});

// æ‰§è¡ŒéªŒè¯
pro.check(['user:create&delete', 'news:create|query']);
// å½“æƒé™é¡¹æ˜¯ä¸€ä¸ªæ•°ç»„æ—¶ï¼Œè¡¨ç¤ºæ¡ä»¶`or`ï¼Œ è¡¨ç¤ºå…¶ä¸­ä»»æ„ä¸€ä¸ªæƒé™é€šè¿‡å³å¯
pro.check(['user:create', ['user:create', 'news:query']]);

// å½“éªŒè¯å¤±è´¥æ—¶, è¿”å›å¦‚ä¸‹çš„ç»“æ„, éªŒè¯æˆåŠŸåˆ™è¿”å›null
// æ ¹æ®metaé…ç½®, è¾“å‡ºçš„åé¦ˆä¿¡æ¯ä¼šæœ‰äº›è®¸ä¸åŒ
[
  {
    label: 'ç”¨æˆ·',
    module: 'user',
    missing: [
      {
        label: 'æ›´æ–°',
        key: 'user.update',
      },
    ],
  },
  {
    label: 'news',
    module: 'news',
    missing: [
      {
        label: 'åˆ›å»º',
        key: 'news.create',
        desc: 'åˆ›å»ºæŸäº›ä¸œè¥¿..',
      },
    ],
  },
]

// å¦‚æœè¦æ›´æ–°æƒé™æˆ–meta
pro.seed.set({
  permission: {...},
  meta: {...},
});
```







