{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/hooks/src/state/useStorageState/useStorageState.ts"],"sourcesContent":["import { StateInitState, SetStateBase, useFn } from \"../../\";\nimport { __GLOBAL__ } from \"@m78/utils\";\nimport { useState } from \"react\";\n\nexport interface UseStorageStateOptions {\n  /** 缓存类型 */\n  type?: \"local\" | \"session\";\n  /** false | 是否禁用缓存 */\n  disabled?: boolean;\n}\n\nconst BASE_KEY = \"USE_STORAGE_CACHE\";\n\nconst storagMethod = {\n  local: (__GLOBAL__ as Window).localStorage,\n  session: (__GLOBAL__ as Window).sessionStorage,\n};\n\nfunction setStorage(\n  key: string,\n  val: any,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  if (val === undefined) return;\n  const method = storagMethod[type!];\n  if (!method) return;\n  method.setItem(`${BASE_KEY}_${key.toUpperCase()}`, JSON.stringify(val));\n}\n\nfunction getStorage(\n  key: string,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  const method = storagMethod[type!];\n  if (!method) return;\n  const cache = method.getItem(`${BASE_KEY}_${key.toUpperCase()}`);\n  return cache === null ? cache : JSON.parse(cache);\n}\n\nfunction remove(\n  key: string,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  const method = storagMethod[type!];\n  if (!method) return;\n  method.removeItem(`${BASE_KEY}_${key.toUpperCase()}`);\n}\n\nconst defaultOptions: Required<UseStorageStateOptions> = {\n  type: \"session\",\n  disabled: false,\n};\n\nfunction useStorageBase<T = undefined>(\n  /** 缓存key */\n  key: string,\n  /** 初始状态 */\n  initState?: StateInitState<T>,\n  /** 其他选项 */\n  options?: UseStorageStateOptions\n): [T, SetStateBase<T>] {\n  const opt = {\n    ...defaultOptions,\n    ...options,\n  };\n\n  const [state, setState] = useState<T>(() => {\n    if (!opt.disabled) {\n      const cache = getStorage(key, opt.type);\n      if (cache !== null) {\n        // null以外的值都视为缓存\n        return cache;\n      }\n    }\n\n    if (initState instanceof Function) {\n      const _initState = initState();\n      !opt.disabled && setStorage(key, _initState, opt.type);\n      return _initState;\n    }\n    !opt.disabled && setStorage(key, initState, opt.type);\n    return initState;\n  });\n\n  const memoSetState: SetStateBase<T> = useFn((patch) => {\n    if (patch instanceof Function) {\n      setState((prev) => {\n        const patchRes = patch(prev);\n        !opt.disabled && setStorage(key, patchRes, opt.type);\n        return patchRes;\n      });\n    } else {\n      !opt.disabled && setStorage(key, patch, opt.type);\n      setState(patch);\n    }\n  });\n\n  return [state, memoSetState];\n}\n\nexport const useStorageState = Object.assign(useStorageBase, {\n  get: getStorage,\n  set: setStorage,\n  remove,\n});\n"],"names":["useFn","__GLOBAL__","useState","BASE_KEY","storagMethod","local","localStorage","session","sessionStorage","setStorage","key","val","type","undefined","method","setItem","toUpperCase","JSON","stringify","getStorage","cache","getItem","parse","remove","removeItem","defaultOptions","disabled","useStorageBase","initState","options","opt","Function","_initState","state","setState","memoSetState","patch","prev","patchRes","useStorageState","Object","assign","get","set"],"mappings":"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"}